<!doctype html>
<html lang="zh-CN">
<head>
  <!-- ...existing code... -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åŸºäºMindSporeçš„YOLOv12å®ç°æ™ºèƒ½äº¤é€šåˆ†æ å‰ç«¯</title>
  <!-- æ–°å¢ Google å­—ä½“å¯é€‰ï¼ˆç¦»çº¿å¯åˆ é™¤ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f7fb;
      --bg-alt: #ffffff;
      --bg-accent: #eef3fb;
      --text: #1f2330;
      --text-light: #586174;
      --primary: #2c7be5;
      --primary-hover: #1b64c2;
      --border: #d9e2ef;
      --radius: 14px;
      --shadow: 0 4px 12px -2px rgba(0,0,0,0.08), 0 2px 4px -1px rgba(0,0,0,0.06);
      --danger: #d93025;
      --warn: #d89614;
      --success: #2e8b57;
      --focus-ring: 0 0 0 3px rgba(44,123,229,.35);
      --gradient: linear-gradient(135deg,#2c7be5 0%, #6a5af9 60%, #8f59ff 100%);
    }
    .dark {
      --bg: #12161d;
      --bg-alt: #1e2530;
      --bg-accent: #262f3b;
      --text: #e6e9ef;
      --text-light: #9aa4b1;
      --primary: #4d8dff;
      --primary-hover: #3374e6;
      --border: #2f3b49;
      --shadow: 0 4px 14px -2px rgba(0,0,0,.6);
      --gradient: linear-gradient(135deg,#1d62d9 0%, #5840e0 60%, #7c3bdc 100%);
    }

    * { box-sizing: border-box; }
    body {
      font-family: "Inter", system-ui, Arial, Helvetica, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
      padding: 0 0 4rem;
    }
    header {
      padding: 2.2rem clamp(1rem,3vw,3rem) 1.2rem;
      background: var(--gradient);
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,.15);
      position: relative;
      overflow: hidden;
    }
    header::after {
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 15% 120%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(circle at 85% -10%, rgba(255,255,255,.25), transparent 55%);
      mix-blend-mode: overlay;
      pointer-events: none;
    }
    h1 {
      margin: 0 0 .4rem;
      font-size: clamp(1.6rem, 2.4vw, 2.4rem);
      letter-spacing:.5px;
      font-weight:600;
    }
    header p { margin:0; opacity:.9; font-size:.95rem; }

    main {
      max-width: 1180px;
      margin: -3rem auto 0;
      padding: 0 clamp(1rem,3vw,3rem);
    }

    form {
      display: grid;
      gap: 1.4rem;
    }

    .card {
      background: var(--bg-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.35rem 1.4rem;
      position: relative;
      box-shadow: var(--shadow);
      transition: border-color .25s, transform .25s;
    }
    .card:hover {
      border-color: var(--primary);
    }
    .card h3 {
      margin: 0 0 .85rem;
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing:.5px;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .step-badge {
      background: var(--primary);
      color:#fff;
      width: 26px;
      height: 26px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      font-size:.82rem;
      font-weight:600;
      box-shadow: 0 2px 4px rgba(0,0,0,.25);
    }

    .row {
      --gap: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap);
    }
    .col {
      flex: 1 1 340px;
      min-width: 260px;
      display:flex;
      flex-direction:column;
      gap:.4rem;
    }

    label {
      font-weight: 600;
      font-size:.85rem;
      letter-spacing:.3px;
      color: var(--text-light);
      text-transform: uppercase;
    }

    input[type="text"],
    select {
      background: var(--bg-accent);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: .65rem .75rem;
      font: inherit;
      color: var(--text);
      outline: none;
      transition: border-color .2s, background .25s, box-shadow .25s;
    }
    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: var(--focus-ring);
      background: var(--bg-alt);
    }

    .file-box {
      position: relative;
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: .9rem;
      background: var(--bg-accent);
      display:flex;
      flex-direction:column;
      gap:.55rem;
      transition: border-color .25s, background .25s;
      cursor: pointer;
    }
    .file-box.dragover {
      border-color: var(--primary);
      background: rgba(44,123,229,.1);
    }
    .file-box input[type="file"] {
      opacity:0;
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      cursor:pointer;
    }
    .file-box .file-hint {
      font-size:.75rem;
      text-transform:uppercase;
      font-weight:600;
      letter-spacing:.5px;
      color: var(--text-light);
    }
    .file-selected {
      font-size:.8rem;
      color: var(--success);
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .hint {
      font-size: .78rem;
      color: var(--text-light);
      line-height:1.4;
      margin-top:.25rem;
    }
    .warn {
      color: var(--warn);
      font-size:.75rem;
      font-weight:500;
      margin-top:.15rem;
    }
    .msgs {
      border:1px solid var(--danger);
      background: rgba(217,48,37,.07);
      padding:.85rem 1rem;
      border-radius:10px;
      font-size:.85rem;
      color: var(--danger);
      display:flex;
      flex-direction:column;
      gap:.3rem;
    }

    .actions {
      display:flex;
      flex-wrap:wrap;
      gap:.9rem;
      align-items:center;
      margin-top:.6rem;
    }
    .btn {
      --btn-bg: var(--primary);
      background: var(--btn-bg);
      color:#fff;
      border:none;
      font: 500 0.95rem/1 "Inter", sans-serif;
      padding:.85rem 1.55rem;
      border-radius: 10px;
      cursor:pointer;
      letter-spacing:.3px;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      position:relative;
      overflow:hidden;
      box-shadow: 0 4px 12px -2px rgba(44,123,229,.4);
      transition: background .25s, transform .25s;
    }
    .btn:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); }
    .btn:active:not(:disabled) { transform: translateY(0); }
    .btn:disabled {
      background: linear-gradient(90deg,#9bbcf1,#9bbcf1);
      cursor:not-allowed;
      opacity:.65;
      box-shadow:none;
    }
    .secondary {
      --btn-bg: var(--bg-accent);
      color: var(--text-light);
      box-shadow:none;
      border:1px solid var(--border);
    }
    .secondary:hover { background: var(--bg-alt); color: var(--text); }

    .toggle-theme {
      position:absolute;
      top:1rem;
      right:1rem;
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.4);
      padding:.55rem .85rem;
      border-radius: 30px;
      font-size:.7rem;
      letter-spacing:1px;
      text-transform:uppercase;
      cursor:pointer;
      color:#fff;
      display:flex;
      align-items:center;
      gap:.4rem;
      transition: background .3s;
    }
    .dark .toggle-theme {
      background: rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.2);
    }
    .toggle-theme:hover { background: rgba(255,255,255,.28); }
    .dark .toggle-theme:hover { background: rgba(255,255,255,.15); }

    .progress {
      position: relative;
      width: 240px;
      height: 10px;
      background: var(--bg-accent);
      border-radius: 6px;
      overflow:hidden;
      border:1px solid var(--border);
      display:none;
    }
    .progress-bar {
      position:absolute;
      inset:0;
      width:0%;
      background: var(--gradient);
      transition: width .35s ease;
    }
    .fade-in {
      animation: fade .5s ease;
    }
    @keyframes fade { from { opacity:0; transform: translateY(4px);} to { opacity:1; transform: translateY(0);} }

    footer {
      margin-top:3rem;
      text-align:center;
      font-size:.75rem;
      color: var(--text-light);
      opacity:.8;
    }

    @media (max-width: 640px) {
      .actions { flex-direction:column; align-items:stretch; }
      .progress { width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <button type="button" class="toggle-theme" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
      <span id="themeIcon">ğŸŒ™</span> <span>ä¸»é¢˜</span>
    </button>
    <h1>åŸºäºMindSporeçš„YOLOv12å®ç°æ™ºèƒ½äº¤é€šåˆ†æ</h1>
    <p>ä¸Šä¼ è§†é¢‘ä¸æ¨¡å‹é…ç½®ï¼Œå®Œæˆæ™ºèƒ½äº¤é€šåˆ†æã€‚</p>
  </header>

  <main>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="msgs fade-in">
          {% for message in messages %}
            <div>{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form id="laneForm" action="{{ url_for('process') }}" method="post" enctype="multipart/form-data" novalidate>
      <div class="card fade-in">
        <h3><span class="step-badge">1</span> ä¸Šä¼ è§†é¢‘</h3>
        <div class="file-box" data-role="drop" data-input="video_file">
          <div class="file-hint">æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©è§†é¢‘ (mp4 / avi / mov / mkv)</div>
          <div class="file-selected" id="video_file_selected">æœªé€‰æ‹©æ–‡ä»¶</div>
          <input type="file" id="video_file" name="video_file" accept="video/*" required>
        </div>
        <div class="hint">è§†é¢‘å°†è¢«ä¸Šä¼ åˆ°æœåŠ¡å™¨è¿›è¡Œæ¨ç†ï¼Œè¯·ç¡®ä¿å¤§å°åˆé€‚ã€‚</div>
      </div>

      <div class="card fade-in">
        <h3><span class="step-badge">2</span> é€‰æ‹©æˆ–ä¸Šä¼ æ¨¡å‹é…ç½®</h3>
        <div class="row">
          <div class="col">
            <label for="selected_config">ä»“åº“ä¸­çš„é…ç½®</label>
            <select name="selected_config" id="selected_config">
              <option value="">-- è¯·é€‰æ‹© --</option>
              {% for c in configs %}
                <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
            <div class="hint">ç¤ºä¾‹ï¼šconfigs/yolov12/yolov12-n.yaml</div>
            <div class="warn" id="config_conflict_msg" style="display:none;">å·²é€‰æ‹©ä¸Šä¼ æ–‡ä»¶ï¼Œå°†å¿½ç•¥æ­¤ä¸‹æ‹‰ã€‚</div>
          </div>
          <div class="col">
            <label>æˆ–ä¸Šä¼ é…ç½® (.yaml / .yml)</label>
            <div class="file-box" data-role="drop" data-input="config_file">
              <div class="file-hint">æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©é…ç½®æ–‡ä»¶</div>
              <div class="file-selected" id="config_file_selected">æœªé€‰æ‹©æ–‡ä»¶</div>
              <input type="file" name="config_file" id="config_file" accept=".yaml,.yml">
            </div>
          </div>
        </div>
      </div>

      <div class="card fade-in">
        <h3><span class="step-badge">3</span> æƒé‡</h3>
        <div class="row">
          <div class="col">
            <label for="weight_path">æœ¬åœ°æƒé‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="weight_path" name="weight_path" placeholder="å¦‚ D:/weights/yolov12n.ckpt">
            <div class="hint">æ”¯æŒç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„ã€‚</div>
          </div>
          <div class="col">
            <label>æˆ–ä¸Šä¼ æƒé‡ (.ckpt / .pt / .bin)</label>
            <div class="file-box" data-role="drop" data-input="weight_file">
              <div class="file-hint">æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©æƒé‡æ–‡ä»¶</div>
              <div class="file-selected" id="weight_file_selected">æœªé€‰æ‹©æ–‡ä»¶</div>
              <input type="file" name="weight_file" id="weight_file" accept=".ckpt,.pt,.bin">
            </div>
          </div>
        </div>
        <div class="hint">è‹¥ç•™ç©ºå°†ä½¿ç”¨éšæœºåˆå§‹åŒ–ï¼Œæ£€æµ‹æ•ˆæœè¾ƒå·®ã€‚</div>
      </div>

      <div class="card fade-in">
        <h3><span class="step-badge">4</span> lane_config</h3>
        <div class="row">
          <div class="col">
            <label for="lane_config_path">lane_config.json è·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="lane_config_path" name="lane_config_path" value="{{ default_lane }}" placeholder="å¦‚ YOLOv12/lane_config.json">
          </div>
          <div class="col">
            <label>æˆ–ä¸Šä¼  lane_config.json</label>
            <div class="file-box" data-role="drop" data-input="lane_config_file">
              <div class="file-hint">æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹© lane_config.json</div>
              <div class="file-selected" id="lane_config_file_selected">æœªé€‰æ‹©æ–‡ä»¶</div>
              <input type="file" name="lane_config_file" id="lane_config_file" accept=".json">
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="submitBtn" type="submit" disabled>å¼€å§‹å¤„ç†</button>
        <button class="btn secondary" type="button" id="resetBtn">é‡ç½®</button>
        <div class="progress" id="progressWrap" aria-label="ä¸Šä¼ è¿›åº¦">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </div>
    </form>

    <footer>
      åŸºäºMindSporeçš„YOLOv12å®ç°æ™ºèƒ½äº¤é€šåˆ†æ å‰ç«¯ç•Œé¢ Â· {{ '%Y'|strftime }} Â· æ”¯æŒæµ…/æ·±è‰²ä¸»é¢˜
    </footer>
  </main>

  <script>
    (function(){
      const qs = sel => document.querySelector(sel);
      const qsa = sel => Array.from(document.querySelectorAll(sel));
      const form = qs('#laneForm');
      const submitBtn = qs('#submitBtn');
      const resetBtn = qs('#resetBtn');
      const progressWrap = qs('#progressWrap');
      const progressBar = qs('#progressBar');
      const themeToggle = qs('#themeToggle');
      const themeIcon = qs('#themeIcon');
      const configSelect = qs('#selected_config');
      const configFile = qs('#config_file');
      const configConflictMsg = qs('#config_conflict_msg');

      // ä¸»é¢˜
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const storedTheme = localStorage.getItem('theme-mode');
      if(storedTheme === 'dark' || (!storedTheme && prefersDark)) {
        document.documentElement.classList.add('dark');
        themeIcon.textContent = 'ğŸŒ';
      }
      themeToggle.addEventListener('click', ()=>{
        document.documentElement.classList.toggle('dark');
        const dark = document.documentElement.classList.contains('dark');
        themeIcon.textContent = dark ? 'ğŸŒ' : 'ğŸŒ™';
        localStorage.setItem('theme-mode', dark ? 'dark' : 'light');
      });

      // æ‹–æ‹½åŒºåŸŸ
      qsa('[data-role="drop"]').forEach(box=>{
        const inputId = box.dataset.input;
        const input = qs('#'+inputId);
        const selectedLabel = qs('#'+inputId+'_selected');
        // box.addEventListener('click', ()=> input.click());
        // ä¿®å¤é‡å¤å¼¹çª—ï¼šè‹¥ç‚¹å‡»äº‹ä»¶æºæœ¬èº«å°±æ˜¯ inputï¼Œåˆ™ä¸å†äºŒæ¬¡è°ƒç”¨ input.click()
       box.addEventListener('click', (e)=>{
          if (e.target === input) return;   // å·²ç”±æµè§ˆå™¨åŸç”Ÿå¤„ç†
          input.click();                    // ä»…åœ¨ç‚¹å‡»å®¹å™¨å…¶å®ƒåŒºåŸŸæ—¶æ‰‹åŠ¨è§¦å‘
       });
        input.addEventListener('change', ()=>{
          if (input.files && input.files[0]) {
            selectedLabel.textContent = input.files[0].name;
            selectedLabel.style.color = 'var(--success)';
            handleConfigConflict();
            validate();
          } else {
            selectedLabel.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            selectedLabel.style.color = '';
            validate();
          }
        });
        ['dragenter','dragover'].forEach(evt=>{
          box.addEventListener(evt, e=>{
            e.preventDefault(); e.stopPropagation();
            box.classList.add('dragover');
          });
        });
        ['dragleave','drop'].forEach(evt=>{
          box.addEventListener(evt, e=>{
            e.preventDefault(); e.stopPropagation();
            box.classList.remove('dragover');
          });
        });
        box.addEventListener('drop', e=>{
          const files = e.dataTransfer.files;
          if(files.length){
            input.files = files;
            input.dispatchEvent(new Event('change'));
          }
        });
      });

      // é…ç½®äº’æ–¥æç¤º
      function handleConfigConflict(){
        const hasUpload = configFile.files && configFile.files.length > 0;
        if(hasUpload){
          configSelect.disabled = true;
          configConflictMsg.style.display = 'block';
        } else {
          configSelect.disabled = false;
          configConflictMsg.style.display = 'none';
        }
      }
      configSelect.addEventListener('change', validate);
      configFile.addEventListener('change', handleConfigConflict);

      // åŸºç¡€æ ¡éªŒï¼šè§†é¢‘æ–‡ä»¶å¿…é¡»ï¼›é…ç½®ä¸‹æ‹‰æˆ–ä¸Šä¼ å…¶ä¸€
      function validate(){
        const videoOk = qs('#video_file').files.length > 0;
        const configOk = (configSelect.value && !configSelect.disabled) || configFile.files.length > 0;
        submitBtn.disabled = !(videoOk && configOk);
      }

      // è¡¨å•æäº¤è¿›åº¦æ¨¡æ‹Ÿï¼ˆçœŸå®å¯æ”¹ä¸º AJAX ä¸Šä¼ åŠ åç«¯è¿›åº¦ï¼‰
      form.addEventListener('submit', (e)=>{
        if(submitBtn.disabled){ e.preventDefault(); return; }
        submitBtn.disabled = true;
        progressWrap.style.display = 'block';
        progressBar.style.width = '0%';
        let pct = 0;
        const timer = setInterval(()=>{
          pct += Math.random()*18;
            if(pct >= 90) pct = 90;
          progressBar.style.width = pct+'%';
        }, 400);
        // è®©æµè§ˆå™¨ç»§ç»­åŸç”Ÿæäº¤ï¼›æ­¤æ—¶æ¨¡æ‹Ÿä¸æ¸…é™¤ intervalï¼ˆé¡µé¢è·³è½¬ä¼šç»“æŸï¼‰
      });

      // é‡ç½®
      resetBtn.addEventListener('click', ()=>{
        form.reset();
        qsa('.file-selected').forEach(el=>{ el.textContent='æœªé€‰æ‹©æ–‡ä»¶'; el.style.color=''; });
        configSelect.disabled = false;
        configConflictMsg.style.display='none';
        progressWrap.style.display='none';
        progressBar.style.width='0%';
        submitBtn.disabled = true;
      });

      validate();
    })();
  </script>
</body>
</html>